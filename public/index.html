<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropmail</title>
    <link href="/css/app.css" rel="stylesheet">
  </head>
  <body>
    <div class="container">
      <div class="col-md-9">
        <h1>Powerful transactional email management</h1>
        <p class="lead">Empowering people to get shit done</p>
      </div>

      <div class="col-md-3">
        <form method="post" action="#" class="signup">
          <div class="form-group">
            <label>Name</label>
            <input class="form-control" type="text" name="name" placeholder="First Last">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input class="form-control" type="email" name="email" placeholder="user@example.com">
          </div>

          <div class="form-group">
            <label>Password</label>
            <input class="form-control" type="password" name="password" placeholder="••••••••">
          </div>

          <button type="submit" class="btn btn-primary" data-loading="Loading…">Sign Up</button>
          <button class="btn btn-default change-form">Sign In</button>
        </form>

        <form method="post" action="#" class="signin">
          <div class="form-group">
            <label>Email</label>
            <input class="form-control" type="email" name="email" placeholder="user@example.com">
          </div>

          <div class="form-group">
            <label>Password</label>
            <input class="form-control" type="password" name="password" placeholder="••••••••">
          </div>

          <button type="submit" class="btn btn-primary" data-loading="Loading…">Sign In</button>
          <button class="btn btn-default change-form">Sign Up</button>
        </form>
      </div>
    </div> <!-- /container -->

    <script src='/js/vendor.js'></script>
    <script src='/js/dropmail.js'></script>
    <script>
      var dm = new Dropmail({ baseURL: 'http://api.dropmail.io' });
      //var dm = new Dropmail({ baseURL: 'http://localhost:9292' });

      $(function() {
        var $signup = $('form.signup');
        dm.User.form($signup, respond($signup, function(err, user) {
          if (err) return console.error(err);
          dm.startSession($signup, window.location.reload.bind(window.location));
        }));

        var $signin = $('form.signin');
        $signin.on('submit', function() {
          dm.startSession($signin, respond($signin, function(err) {
            $signin.find('.alert').remove();

            if (err) {
              $signin.prepend("<div class='alert alert-danger'>" + err.message + "</div>");
            } else {
              window.location.reload();
            }

          }));

          return false;
        });

        $signin.hide();
        $('button.change-form').on('click', handleFormChange);

        function handleFormChange() {
          $signin.toggle();
          $signup.toggle();

          return false;
        }

        function respond($form, callback){
          var $button = $(this).children('button')
            , buttonText = $button.text();

          return function(err, object){
            $form.find('.form-group').removeClass('has-error');
            $form.find('.help-block').remove();

            if (err) {
              var errors = err.attributes;

              for (var name in errors) {
                var input = $form.find('input[name=' + name + ']');
                input.closest('.form-group').addClass('has-error');
                input.after("<div class='help-block'>" + toSentence(errors[name]) + '</div>');
              }

              $button.attr('disabled', false).text(buttonText);
            }

            callback(err, object);
          };
        }

        function toSentence(array){
          return array.join(', ');
        }
      });
    </script>
  </body>
</html>
