<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Dropmail</title>
    <link href='css/dropmail.css' rel='stylesheet'>
  </head>

  <body>
    <div class='container'>
      <div class='row'>
        <div class='span12'>
          <div class='navbar'>
            <ul class='nav pull-right actions'>
              <li><a href='#'>Features</a></li>
              <li><a href='#'>Pricing</a></li>
            </ul>
          </div>
          <div class='header-logo'>
            <a href='/'>Dropmail</a>
          </div>
        </div>
      </div>

      <div class='row'>
        <div class='span9'>
          <h1>Powerful transactional email management</h1>
          <p class='lead'>Empowering people to get shit done</p>
        </div>

        <div class='span3'>
          <form action='#' method='post' class='signup'>
            <div class='control-group'>
              <label class='control-label' for='name'>Name</label>
              <div class='controls'>
                <input type='text' name='name' placeholder='First Last'>
              </div>
            </div>
            <div class='control-group'>
              <label class='control-label' for='email'>Email</label>
              <div class='controls'>
                <input type='email' name='email' placeholder='user@example.com'>
              </div>
            </div>
            <div class='control-group'>
              <label class='control-label' for='password'>Password</label>
              <div class='controls'>
                <input type='password' name='password' placeholder='••••••••'>
              </div>
            </div>
            <button class='btn btn-primary' type='submit' data-loading='Loading…'>Sign Up</button>
          </form>
        </div>
      </div>
    </div>

    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js'></script>
    <script src='js/vendor/jquery.cookie.js'></script>
    <script src='js/dropmail.js'></script>
    <script src='js/ui.js'></script>

    <script>
      Dropmail.baseURL = 'http://0.0.0.0:9393';
      var dropmail = new Dropmail();
      dropmail.authenticate($.cookie('key'));

      $(function(){
        var $form = $('form.signup');

        if (dropmail.credentials) {
          dropmail.User.me(function(err, user){
            if (err) return signedOut();
            signedIn(user);
          });
        } else {
          signedOut();
        }

        function signedOut(){
          dropmail.User.form($form, function(err, user){
            if (err) { return ui.handleValidation(err, $form); }

            dropmail.authenticate(user);
            dropmail.Authorization.save(function(err, auth){
              if (err) { /* TODO: handle errors */ }

              dropmail.authenticate(auth);
              $.cookie('key', auth.get('key'));

              signedIn(user);
            });;
          });
        }

        function signedIn(user){
          $form.replaceWith(
            '<div>Hi ' + user.get('name') + ', thanks for signing up!<' + '/div>'
          );
        }
      });

    </script>
  </body>
</html>
